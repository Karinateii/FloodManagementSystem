@model GlobalDisasterManagement.Models.IoTSensor
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<GlobalDisasterManagement.Resources.SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["Sensor Details"];
    var sensorType = Model switch
    {
        GlobalDisasterManagement.Models.WaterLevelSensor => "Water Level",
        GlobalDisasterManagement.Models.RainfallSensor => "Rainfall",
        GlobalDisasterManagement.Models.WeatherSensor => "Weather",
        _ => "Sensor"
    };
}

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Index">@Localizer["IoT Monitoring"]</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="display-5 mb-2">@Model.Name</h1>
                    <p class="text-muted">
                        <span class="badge bg-secondary me-2">@sensorType</span>
                        <span class="badge bg-@(Model.Status == GlobalDisasterManagement.Models.SensorStatus.Active ? "success" : "secondary")">
                            @Model.Status
                        </span>
                    </p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> @Localizer["Refresh"]
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Information Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Localizer["Device ID"]</h6>
                    <p class="mb-0 font-monospace">@Model.DeviceId</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Localizer["Location"]</h6>
                    <p class="mb-0">@Model.Address</p>
                    <small class="text-muted">@Model.Latitude.ToString("F4"), @Model.Longitude.ToString("F4")</small>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Localizer["Installed Date"]</h6>
                    <p class="mb-0">@Model.InstallationDate.ToString("MMM dd, yyyy")</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Localizer["Last Update"]</h6>
                    <p class="mb-0" id="lastUpdate">
                        @if (Model.LastDataReceivedDate.HasValue)
                        {
                            @Model.LastDataReceivedDate.Value.ToString("MMM dd, HH:mm")
                        }
                        else
                        {
                            <span>@Localizer["Never"]</span>
                        }
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Type-Specific Current Readings -->
    @if (Model is GlobalDisasterManagement.Models.WaterLevelSensor waterSensor)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-water text-info"></i> @Localizer["Current Water Level"]
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Current Level"]</small>
                                    <h2 class="mb-0 text-info">@(waterSensor.CurrentLevel?.ToString("F2") ?? "N/A")m</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Normal Level"]</small>
                                    <h4 class="mb-0 text-success">@(waterSensor.NormalLevel.ToString("F2"))m</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["High Level"]</small>
                                    <h4 class="mb-0 text-warning">@(waterSensor.WarningLevel.ToString("F2"))m</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Critical Level"]</small>
                                    <h4 class="mb-0 text-danger">@(waterSensor.CriticalLevel.ToString("F2"))m</h4>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">@Localizer["Water Body"]: <strong>@waterSensor.WaterBodyType</strong></label>
                            <div class="progress" style="height: 25px;">
                                @{
                                    var percentage = waterSensor.CurrentLevel.HasValue
                                        ? Math.Min((waterSensor.CurrentLevel.Value / waterSensor.CriticalLevel * 100), 100)
                                        : 0;
                                    var statusColor = waterSensor.CurrentStatus switch
                                    {
                                        GlobalDisasterManagement.Models.WaterLevelStatus.Critical => "danger",
                                        GlobalDisasterManagement.Models.WaterLevelStatus.Warning => "warning",
                                        GlobalDisasterManagement.Models.WaterLevelStatus.Normal => "info",
                                        _ => "success"
                                    };
                                }
                                <div class="progress-bar bg-@statusColor" role="progressbar" 
                                     style="width: @percentage%" 
                                     aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                    @percentage.ToString("F1")%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (Model is GlobalDisasterManagement.Models.RainfallSensor rainfallSensor)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud-rain text-success"></i> @Localizer["Current Rainfall"]
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Current Rate"]</small>
                                    <h2 class="mb-0 text-primary">@(rainfallSensor.CurrentRainfall?.ToString("F1") ?? "0") mm/h</h2>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Hourly Total"]</small>
                                    <h3 class="mb-0 text-info">@(rainfallSensor.HourlyRainfall?.ToString("F1") ?? "0") mm</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Daily Total"]</small>
                                    <h3 class="mb-0 text-success">@(rainfallSensor.DailyRainfall?.ToString("F1") ?? "0") mm</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block">@Localizer["Intensity"]</small>
                                    <h4 class="mb-0">
                                        <span class="badge bg-@(rainfallSensor.CurrentIntensity == GlobalDisasterManagement.Models.RainfallIntensity.VeryHeavy ? "danger" : 
                                            rainfallSensor.CurrentIntensity == GlobalDisasterManagement.Models.RainfallIntensity.Heavy ? "warning" : "info")">
                                            @rainfallSensor.CurrentIntensity
                                        </span>
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (Model is GlobalDisasterManagement.Models.WeatherSensor weatherSensor)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud-sun text-warning"></i> @Localizer["Current Weather Conditions"]
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-thermometer-half text-danger fa-2x mb-2"></i>
                                    <small class="text-muted d-block">@Localizer["Temperature"]</small>
                                    <h4 class="mb-0">@(weatherSensor.CurrentTemperature?.ToString("F1") ?? "N/A")°C</h4>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-tint text-info fa-2x mb-2"></i>
                                    <small class="text-muted d-block">@Localizer["Humidity"]</small>
                                    <h4 class="mb-0">@(weatherSensor.CurrentHumidity?.ToString("F0") ?? "N/A")%</h4>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-wind text-primary fa-2x mb-2"></i>
                                    <small class="text-muted d-block">@Localizer["Wind Speed"]</small>
                                    <h4 class="mb-0">@(weatherSensor.CurrentWindSpeed?.ToString("F1") ?? "N/A") km/h</h4>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-compass text-secondary fa-2x mb-2"></i>
                                    <small class="text-muted d-block">@Localizer["Wind Direction"]</small>
                                    <h4 class="mb-0">@(weatherSensor.CurrentWindDirection?.ToString("F0") ?? "N/A")°</h4>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-compress text-dark fa-2x mb-2"></i>
                                    <small class="text-muted d-block">@Localizer["Pressure"]</small>
                                    <h4 class="mb-0">@(weatherSensor.CurrentPressure?.ToString("F0") ?? "N/A") hPa</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Historical Data Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> @Localizer["Historical Data (24 Hours)"]
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" onclick="changePeriod('24h')">24h</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="changePeriod('7d')">7d</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="changePeriod('30d')">30d</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="historicalChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Location -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marked-alt"></i> @Localizer["Sensor Location"]
                    </h5>
                </div>
                <div class="card-body">
                    <div id="sensorMap" style="height: 400px; border-radius: 8px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        const sensorId = '@Model.Id';
        const sensorType = '@sensorType';
        let historicalChart;

        // Initialize Map
        const map = L.map('sensorMap').setView([@Model.Latitude, @Model.Longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([@Model.Latitude, @Model.Longitude])
            .addTo(map)
            .bindPopup('<b>@Model.Name</b><br>@Model.Address')
            .openPopup();

        // Initialize Chart
        const ctx = document.getElementById('historicalChart').getContext('2d');
        historicalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '@Localizer["Reading"]',
                    data: [],
                    backgroundColor: 'rgba(13, 110, 253, 0.2)',
                    borderColor: 'rgb(13, 110, 253)',
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Load historical data (mock for now)
        loadHistoricalData('24h');

        function loadHistoricalData(period) {
            // In production, fetch from API: /api/IoTSensor/{id}/history?period={period}
            console.log(`Loading ${period} data for sensor ${sensorId}`);
            // Mock data - replace with actual API call
        }

        function changePeriod(period) {
            document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadHistoricalData(period);
        }

        function refreshData() {
            location.reload();
        }

        // SignalR Connection for real-time updates
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/iotMonitoringHub")
            .withAutomaticReconnect()
            .build();

        connection.on("SensorUpdate", function (data) {
            if (data.SensorId === sensorId) {
                console.log("Sensor Update:", data);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                // Update display values based on sensor type
            }
        });

        connection.start()
            .then(() => {
                console.log("SignalR Connected");
                connection.invoke("SubscribeToSensor", sensorId)
                    .catch(err => console.error(err));
            })
            .catch(err => console.error(err));
    </script>
}
